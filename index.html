<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d9488">
    <title>ÊóÖÈÅäË°åÁ®ãË¶èÂäÉ (Èõ≤Á´ØÁâà)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-modal { animation: fadeIn 0.15s ease-out forwards; }
        .animate-toast { animation: slideUp 0.3s ease-out forwards; }
        .dragging { opacity: 0.5; background: #f0fdfa; border: 2px dashed #0d9488; }
        .prose h3 { font-size: 1.1rem; font-weight: bold; margin-top: 1rem; color: #0f766e; }
        .prose ul { list-style-type: disc; padding-left: 1.2rem; margin-top: 0.5rem; }
        .prose li { margin-bottom: 0.25rem; }
        .prose strong { color: #115e59; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://dtzpkhrbyykceijxbhtd.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_rhrApXCDCaVI2bHoiUkpZA_3yCxtss2'; // ‰ΩøÁî®ËÄÖÊèê‰æõÁöÑ Key
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const Icon = ({ p, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{p}</svg>
        );
        const icons = {
            Camera: <><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>,
            Utensils: <><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></>,
            Train: <><rect width="16" height="16" x="4" y="4" rx="2"/><path d="M4 11h16"/><path d="M12 4v16"/><path d="m8 15-2 2"/><path d="m16 15 2 2"/></>,
            BedDouble: <><path d="M2 20v-8a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8"/><path d="M4 10V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"/><path d="M12 4v6"/><path d="M2 18h20"/></>,
            MapPin: <><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></>,
            Plus: <><path d="M5 12h14"/><path d="M12 5v14"/></>,
            Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6"/><path d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
            Edit2: <><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></>,
            DollarSign: <><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></>,
            Plane: <><path d="M2 12h5"/><path d="M11 7v5l-4 4H2"/><path d="m14 7 1.5-4.5h3.5L14 11v6.5l3.5 1.5-2 3.5-3.5-3.5L9 15v-3z"/></>,
            Navigation: <><polygon points="3 11 22 2 13 21 11 13 3 11"/></>,
            Home: <><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
            AlertTriangle: <><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>,
            FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></>,
            List: <><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></>,
            ArrowLeft: <><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
            Upload: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>,
            GripVertical: <><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></>,
            ArrowUpDown: <><path d="m21 16-4 4-4-4"/><path d="M17 20V4"/><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/></>,
            Check: <><polyline points="20 6 9 17 4 12"/></>,
            Copy: <><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></>,
            Settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
            Sparkles: <><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 17v4"/><path d="M21 19h-4"/></>,
            Loader2: <><path d="M21 12a9 9 0 1 1-6.219-8.56"/></>,
            Youtube: <><path d="M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17"/><path d="m10 15 5-3-5-3z"/></>,
            Presentation: <><path d="M2 3h20"/><path d="M21 3v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3"/><path d="m7 21 5-5 5 5"/></>,
            Table: <><path d="M12 3v18"/><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/></>,
            Link: <><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></>,
            PieChart: <><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>,
            Receipt: <><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 17V7"/></>,
            StickyNote: <><path d="M15.5 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z"/><path d="M15 3v6h6"/></>,
            Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
            Smartphone: <><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></>,
            Monitor: <><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></>,
            Cloud: <><path d="M17.5 19c0-1.7-1.3-3-3-3h-11c-1.7 0-3 1.3-3 3s1.3 3 3 3h11c1.7 0 3-1.3 3-3z"/><path d="M17.5 19c2.5 0 4.5-2 4.5-4.5S19.5 10 17 10c-.3 0-.6.1-.9.1"/><path d="M16.1 10.1C16.5 7.2 18.9 5 21.9 5c3.3 0 6 2.7 6 6s-2.7 6-6 6h-2.5"/><path d="M6 16c-2.2 0-4-1.8-4-4s1.8-4 4-4c.3 0 .6.1.9.1"/><path d="M6.9 8.1C7.3 5.2 9.7 3 12.7 3c3.3 0 6 2.7 6 6s-2.7 6-6 6H9.5"/></>
        };
        const LucideIcon = ({ name, ...p }) => <Icon p={icons[name] || icons.MapPin} {...p} />;

        const InputField = ({ label, ...props }) => (
            <div>
                {label && <label className="block text-xs font-bold text-slate-500 mb-1">{label}</label>}
                <input className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none text-base" {...props} />
            </div>
        );

        const CostInput = ({ label, value, onChange }) => (
            <div>
                {label && <label className="block text-xs font-bold text-slate-500 mb-1">{label}</label>}
                <div className="relative">
                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span>
                    <input 
                        type="number" 
                        name="cost" 
                        value={value} 
                        onChange={onChange} 
                        placeholder="0"
                        className="w-full bg-slate-50 border border-slate-200 rounded-lg pl-7 pr-3 py-2 focus:ring-2 focus:ring-teal-500 focus:outline-none text-base" 
                    />
                </div>
            </div>
        );

        const TYPE_CONFIG = { 
            sight: { icon: "Camera", color: 'bg-blue-100 text-blue-600', label: 'ÊôØÈªû/ÈñÄÁ•®', chartColor: '#3b82f6' }, 
            food: { icon: "Utensils", color: 'bg-orange-100 text-orange-600', label: 'È§êÈ£≤/ÁæéÈ£ü', chartColor: '#f97316' }, 
            transport: { icon: "Train", color: 'bg-green-100 text-green-600', label: '‰∫§ÈÄö', chartColor: '#22c55e' }, 
            stay: { icon: "BedDouble", color: 'bg-purple-100 text-purple-600', label: '‰ΩèÂÆø', chartColor: '#a855f7' }, 
            other: { icon: "MapPin", color: 'bg-gray-100 text-gray-600', label: 'ÂÖ∂‰ªñ/Ë≥ºÁâ©', chartColor: '#64748b' } 
        };
        
        const INITIAL_DATA = { 
            tripName: "Â§ßÈò™Áí∞ÁêÉÂΩ±Âüé‰∫îÊó•ÈÅä", 
            startDate: "2025-02-05", 
            days: 5, 
            currency: "TWD", 
            memo: "", 
            dayTitles: {
                "1": "Âá∫ÁôºËàáÈõ£Ê≥¢Êé¢Á¥¢",
                "2": "Êó•Êú¨Áí∞ÁêÉÂΩ±ÂüéÂÖ®Êó•",
                "3": "Ëá™Áî±Ë°åÁ®ã",
                "4": "Ëá™Áî±Ë°åÁ®ã",
                "5": "Ë≥ºÁâ©ËàáÊ≠∏Ë≥¶"
            },
            accommodations: { 
                1: { title: "Â§ßÈò™Èõ£Ê≥¢È£ØÂ∫ó", location: "Áõ∏Èêµ FRESA INN Â§ßÈò™Èõ£Ê≥¢Á´ôÂâç", cost: 0 }, 
                2: { title: "Â§ßÈò™Èõ£Ê≥¢È£ØÂ∫ó", location: "Áõ∏Èêµ FRESA INN Â§ßÈò™Èõ£Ê≥¢Á´ôÂâç", cost: 0 }, 
                3: { title: "Â§ßÈò™Èõ£Ê≥¢È£ØÂ∫ó", location: "Áõ∏Èêµ FRESA INN Â§ßÈò™Èõ£Ê≥¢Á´ôÂâç", cost: 0 }, 
                4: { title: "Â§ßÈò™Èõ£Ê≥¢È£ØÂ∫ó", location: "Áõ∏Èêµ FRESA INN Â§ßÈò™Èõ£Ê≥¢Á´ôÂâç", cost: 0 } 
            }, 
            activities: [ 
                { id: 101, day: 1, time: "05:00", title: "Âá∫ÈñÄÂâçÂæÄÊ©üÂ†¥", location: "Ê°ÉÂúíÂúãÈöõÊ©üÂ†¥", type: "transport", cost: 0, note: "Ê∫ñÂÇôÂá∫Áôº" }, 
                { id: 102, day: 1, time: "09:00", title: "Êê≠‰πòÈ£õÊ©üÔºöÊ°ÉÂúí -> Â§ßÈò™", location: "ÈóúË•øÂúãÈöõÊ©üÂ†¥", type: "transport", cost: 0, note: "09:00 Âè∞ÁÅ£ÊôÇÈñìÂá∫ÁôºÔºå12:30 Êó•Êú¨ÊôÇÈñìÊäµÈÅî" }, 
                { id: 103, day: 1, time: "13:30", title: "ÂâçÂæÄÈ£ØÂ∫ó", location: "Áõ∏Èêµ FRESA INN Â§ßÈò™Èõ£Ê≥¢Á´ôÂâç", type: "transport", cost: 0, note: "Ëæ¶ÁêÜ Check-in" }, 
                { id: 104, day: 1, time: "16:00", title: "Èõ£Ê≥¢„ÄÅÂøÉÈΩãÊ©ã", location: "Èõ£Ê≥¢/ÂøÉÈΩãÊ©ãÂïÜÂúà", type: "sight", cost: 0, note: "ÈÄõË°óËàáÊôöÈ§ê" }, 
                { id: 201, day: 2, time: "08:00", title: "Êó•Êú¨Áí∞ÁêÉÂΩ±Âüé (USJ)", location: "Êó•Êú¨Áí∞ÁêÉÂΩ±Âüé", type: "sight", cost: 0, note: "Êï¥Êó•Ë°åÁ®ã" }, 
                { id: 301, day: 3, time: "09:00", title: "Ëá™Áî±Ë°åÁ®ã", location: "Â§ßÈò™Â∏ÇÂçÄ", type: "sight", cost: 0, note: "Êú™ÂÆöË°åÁ®ã" }, 
                { id: 401, day: 4, time: "09:00", title: "Ëá™Áî±Ë°åÁ®ã", location: "Â§ßÈò™Â∏ÇÂçÄ", type: "sight", cost: 0, note: "Êú™ÂÆöË°åÁ®ã" }, 
                { id: 501, day: 5, time: "10:00", title: "ÈõªÈõªË°ó", location: "Êó•Êú¨Ê©ãÈõªÈõªË°ó", type: "sight", cost: 0, note: "ÂãïÊº´„ÄÅÈõªÂ≠êÁî¢ÂìÅÂ∑°Á¶Æ" }, 
                { id: 502, day: 5, time: "13:30", title: "Ëá®Á©∫Âüé OUTLET", location: "Rinku Premium Outlets", type: "other", cost: 0, note: "ÊúÄÂæåÊé°Ë≤∑" }, 
                { id: 503, day: 5, time: "18:15", title: "Âà∞ÈÅîÊ©üÂ†¥", location: "ÈóúË•øÂúãÈöõÊ©üÂ†¥", type: "transport", cost: 0, note: "Ëæ¶ÁêÜÁôªÊ©üÊâãÁ∫å" }, 
                { id: 504, day: 5, time: "20:45", title: "Êê≠‰πòÈ£õÊ©üÔºöÂ§ßÈò™ -> Ê°ÉÂúí", location: "Ê°ÉÂúíÂúãÈöõÊ©üÂ†¥", type: "transport", cost: 0, note: "20:45 Êó•Êú¨ÊôÇÈñìÂá∫ÁôºÔºå23:05 Âè∞ÁÅ£ÊôÇÈñìÊäµÈÅî" } 
            ],
            expenses: [] 
        };

        const callGemini = async (prompt, key, onResult, onError) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    if (!res.ok) throw new Error(res.statusText);
                    const data = await res.json();
                    onResult(data.candidates?.[0]?.content?.parts?.[0]?.text || "ÁÑ°ÂõûÊáâ");
                    return;
                } catch (e) {
                    if (i < delays.length) await new Promise(r => setTimeout(r, delays[i]));
                    else onError(e.message);
                }
            }
        };

        const getLinkData = (url) => {
            if (!url) return null;
            if (url.includes('youtube.com') || url.includes('youtu.be')) return { icon: "Youtube", label: "ÂΩ±Áâá", color: "text-red-600 border-red-200 bg-red-50 hover:bg-red-100" };
            if (url.includes('presentation') || url.includes('slides')) return { icon: "Presentation", label: "Á∞°Â†±", color: "text-orange-600 border-orange-200 bg-orange-50 hover:bg-orange-100" };
            if (url.includes('spreadsheets') || url.includes('sheets')) return { icon: "Table", label: "Ë©¶ÁÆóË°®", color: "text-green-600 border-green-200 bg-green-50 hover:bg-green-100" };
            if (url.includes('document') || url.includes('docs')) return { icon: "FileText", label: "Êñá‰ª∂", color: "text-blue-600 border-blue-200 bg-blue-50 hover:bg-blue-100" };
            return { icon: "Link", label: "ÈÄ£Áµê", color: "text-slate-600 border-slate-200 bg-slate-50 hover:bg-slate-100" };
        };

        const PieChart = ({ data }) => {
            const total = data.reduce((sum, item) => sum + item.value, 0);
            if (total === 0) return <div className="text-center text-slate-400 py-10">Â∞öÁÑ°Ëä±Ë≤ªË≥áÊñô</div>;
            let cumulativePercent = 0;
            return (
                <div className="flex flex-col items-center">
                    <div className="relative w-48 h-48">
                        <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full">
                            {data.map((item, i) => {
                                const percent = item.value / total;
                                const dashVal = percent * 100;
                                cumulativePercent += dashVal;
                                return (
                                    <circle key={i} r="15.9155" cx="50" cy="50" fill="transparent" stroke={item.color} strokeWidth="6" strokeDasharray={`${dashVal} ${100 - dashVal}`} strokeDashoffset={25 + 100 - (cumulativePercent - dashVal)} className="transition-all duration-500" />
                                );
                            })}
                            <foreignObject x="0" y="0" width="100" height="100">
                                <div className="h-full flex flex-col items-center justify-center text-[8px] text-slate-500">
                                    <span>Á∏ΩÊîØÂá∫</span>
                                    <span className="font-bold text-slate-800 text-[12px]">${total.toLocaleString()}</span>
                                </div>
                            </foreignObject>
                        </svg>
                    </div>
                    <div className="w-full mt-6 space-y-2">
                        {data.sort((a,b) => b.value - a.value).map((item, i) => (
                            <div key={i} className="flex justify-between items-center text-sm">
                                <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full" style={{backgroundColor: item.color}}></div><span className="text-slate-600">{item.label}</span></div>
                                <div className="flex gap-4"><span className="font-bold text-slate-800">${item.value.toLocaleString()}</span><span className="text-slate-400 w-10 text-right">{Math.round((item.value/total)*100)}%</span></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        function App() {
            const dragItem = useRef();
            const dragOverItem = useRef();
            const fileInputRef = useRef(null);
            
            // State
            const [trip, setTrip] = useState(() => {
                const saved = localStorage.getItem('travelApp_data');
                if (saved) { try { const p = JSON.parse(saved); 
                    if(!p.accommodations) p.accommodations={}; 
                    if(!p.activities) p.activities=[]; 
                    if(!p.expenses) p.expenses=[];
                    if(!p.dayTitles) p.dayTitles={};
                    if(!p.memo) p.memo = "";
                    return p; } catch (e) { return INITIAL_DATA; } }
                return INITIAL_DATA;
            });
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || "");
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [syncStatus, setSyncStatus] = useState("idle"); // idle, syncing, done, error
            const [showSavedToast, setShowSavedToast] = useState(false);
            
            // View State
            const [currentDay, setCurrentDay] = useState(1);
            const [isSummaryView, setIsSummaryView] = useState(false); 
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalType, setModalType] = useState('activity'); 
            const [editingId, setEditingId] = useState(null);
            const [applyToRemaining, setApplyToRemaining] = useState(false);
            const [formData, setFormData] = useState({ time: "09:00", title: "", location: "", links: [], type: "sight", cost: "", note: "" });
            const [errorMsg, setErrorMsg] = useState(""); 
            const [exportText, setExportText] = useState(""); 
            const [importText, setImportText] = useState(""); 
            const [aiResult, setAiResult] = useState("");
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [memoText, setMemoText] = useState("");
            
            // Auth Form
            const [authEmail, setAuthEmail] = useState("");
            const [authPass, setAuthPass] = useState("");
            const [isLoginMode, setIsLoginMode] = useState(true);

            // --- Effects ---
            useEffect(() => {
                // Check Auth Status
                const checkUser = async () => {
                    const { data: { session } } = await supabase.auth.getSession();
                    setUser(session?.user || null);
                    setAuthLoading(false);
                    if (session?.user) loadFromCloud(session.user.id);
                };
                checkUser();
                
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setUser(session?.user || null);
                    if (session?.user) loadFromCloud(session.user.id);
                });
                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => { 
                // Local Save
                localStorage.setItem('travelApp_data', JSON.stringify(trip)); 
                
                // Cloud Sync (Auto Save)
                if (user) {
                    saveToCloud(trip);
                }

                setShowSavedToast(true);
                const timer = setTimeout(() => setShowSavedToast(false), 2000);
                return () => clearTimeout(timer);
            }, [trip]);
            
            useEffect(() => { localStorage.setItem('gemini_api_key', apiKey); }, [apiKey]);

            // --- Cloud Functions ---
            const loadFromCloud = async (userId) => {
                setSyncStatus("syncing");
                const { data, error } = await supabase
                    .from('trips')
                    .select('trip_data')
                    .eq('user_id', userId)
                    .single();
                
                if (data && data.trip_data) {
                    // Conflict resolution: Simple prompt or just load?
                    // For now, let's load if local is default, otherwise ask (mock ask by just loading for now to be seamless)
                    // Better UX: If cloud data exists, ask user if they want to overwrite local
                    if (JSON.stringify(trip) !== JSON.stringify(INITIAL_DATA) && confirm("ÁôºÁèæÈõ≤Á´ØÊúâÂÇô‰ªΩË°åÁ®ãÔºåÊòØÂê¶Ë¶Å‰∏ãËºâË¶ÜËìãÁõÆÂâçÁöÑÈÄ≤Â∫¶Ôºü")) {
                        setTrip(data.trip_data);
                    } else if (JSON.stringify(trip) === JSON.stringify(INITIAL_DATA)) {
                        setTrip(data.trip_data);
                    }
                }
                setSyncStatus("done");
                setTimeout(() => setSyncStatus("idle"), 2000);
            };

            const saveToCloud = async (currentTrip) => {
                if (!user) return;
                setSyncStatus("syncing");
                const { error } = await supabase
                    .from('trips')
                    .upsert({ user_id: user.id, trip_data: currentTrip, updated_at: new Date() });
                
                if (error) {
                    console.error("Cloud save failed:", error);
                    setSyncStatus("error");
                } else {
                    setSyncStatus("done");
                    setTimeout(() => setSyncStatus("idle"), 2000);
                }
            };

            const handleAuth = async () => {
                setAuthLoading(true);
                if (isLoginMode) {
                    const { error } = await supabase.auth.signInWithPassword({ email: authEmail, password: authPass });
                    if (error) alert(error.message);
                    else { setIsModalOpen(false); alert("ÁôªÂÖ•ÊàêÂäüÔºÅË°åÁ®ãÂ∞áËá™ÂãïÂêåÊ≠•„ÄÇ"); }
                } else {
                    const { error } = await supabase.auth.signUp({ email: authEmail, password: authPass });
                    if (error) alert(error.message);
                    else { alert("Ë®ªÂÜäÊàêÂäüÔºÅË´ãÊ™¢Êü• Email È©óË≠â‰ø°„ÄÇ"); setIsLoginMode(true); }
                }
                setAuthLoading(false);
            };

            const handleLogout = async () => {
                await supabase.auth.signOut();
                setUser(null);
                alert("Â∑≤ÁôªÂá∫");
                setIsModalOpen(false);
            };

            // --- Interaction Handlers ---
            const handleInputChange = (e) => { setFormData({ ...formData, [e.target.name]: e.target.value }); setErrorMsg(""); };
            const handleDragStart = (e, pos) => { dragItem.current = pos; e.target.classList.add('dragging'); };
            const handleDragEnter = (e, pos) => { dragOverItem.current = pos; };
            const handleDragEnd = (e) => { e.target.classList.remove('dragging'); dragItem.current = null; dragOverItem.current = null; };

            const handleActivitySort = () => {
                let _acts = [...trip.activities];
                const dayActs = _acts.filter(a => a.day === currentDay);
                const draggedAct = dayActs[dragItem.current];
                const overAct = dayActs[dragOverItem.current];
                if (!draggedAct || !overAct || draggedAct === overAct) return;
                const idx1 = _acts.findIndex(a => a.id === draggedAct.id);
                const idx2 = _acts.findIndex(a => a.id === overAct.id);
                const item = _acts.splice(idx1, 1)[0];
                _acts.splice(idx2, 0, item);
                setTrip(prev => ({ ...prev, activities: _acts }));
            };

            const handleDaySort = () => {
                const d1 = dragItem.current + 1; const d2 = dragOverItem.current + 1;
                if (dragItem.current === undefined || dragOverItem.current === undefined || d1 === d2) return;
                setTrip(prev => {
                    const newActs = prev.activities.map(a => a.day === d1 ? { ...a, day: d2 } : a.day === d2 ? { ...a, day: d1 } : a);
                    const newAcc = { ...prev.accommodations };
                    const temp = newAcc[d1]; newAcc[d1] = newAcc[d2]; newAcc[d2] = temp;
                    const newExp = (prev.expenses || []).map(e => e.day === d1 ? { ...e, day: d2 } : e.day === d2 ? { ...e, day: d1 } : e);
                    const newTitles = { ...prev.dayTitles };
                    const t = newTitles[d1]; newTitles[d1] = newTitles[d2]; newTitles[d2] = t;
                    return { ...prev, activities: newActs, accommodations: newAcc, expenses: newExp, dayTitles: newTitles };
                });
            };

            const autoSortByTime = () => {
                setTrip(prev => {
                    const others = prev.activities.filter(a => a.day !== currentDay);
                    const current = prev.activities.filter(a => a.day === currentDay).sort((a, b) => a.time.localeCompare(b.time));
                    return { ...prev, activities: [...others, ...current] };
                });
                setIsModalOpen(false);
            };

            const runAIAnalysis = () => {
                if (!apiKey) { setErrorMsg("Ë´ãÂÖàËº∏ÂÖ• API Key"); setModalType('settings'); setIsModalOpen(true); return; }
                const dayActs = trip.activities.filter(a => a.day === currentDay);
                const dayAcc = trip.accommodations?.[currentDay];
                const prompt = `Ë´ãÊìî‰ªªÂ∞àÊ•≠Â∞éÈÅä„ÄÇÈÄôÊòØÊàëÁöÑÁ¨¨ ${currentDay} Â§©Ë°åÁ®ãÔºö${dayActs.map(a => `- ${a.time} ${a.title} (${a.location||''})`).join('\n')} ‰ΩèÂÆøÔºö${dayAcc?.title||'Êú™ÂÆö'}„ÄÇË´ãÊèê‰æõÁπÅÈ´î‰∏≠ÊñáÂª∫Ë≠∞Ôºö1.ÊôÇÈñìÂÆâÊéí 2.‰∫§ÈÄö 3.ÁæéÈ£ü„ÄÇ`;
                setIsAiLoading(true); setModalType('ai_result'); setIsModalOpen(true);
                callGemini(prompt, apiKey, (text) => { setAiResult(text); setIsAiLoading(false); }, (err) => { setAiResult("ÈÄ£Á∑öÈåØË™§: " + err); setIsAiLoading(false); });
            };

            const openModal = (act = null) => {
                setModalType('activity'); setEditingId(act ? act.id : null);
                const initLinks = act?.links ? [...act.links] : (act?.driveLink ? [{url: act.driveLink, title: ''}] : []);
                setFormData(act ? { ...act, cost: act.cost, links: initLinks } : { time: "09:00", title: "", location: "", links: [], type: "sight", cost: "", note: "" });
                setErrorMsg(""); setIsModalOpen(true);
            };

            const openAccModal = () => {
                setModalType('accommodation'); const curr = trip.accommodations?.[currentDay] || { title: "", location: "", cost: 0 };
                setFormData({ title: curr.title, location: curr.location, links: [], type: "stay", cost: curr.cost || 0, note: "" });
                setApplyToRemaining(false); setErrorMsg(""); setIsModalOpen(true);
            };

            const openExpenseModal = (exp = null) => {
                setModalType('expense'); setEditingId(exp ? exp.id : null);
                setFormData(exp ? { ...exp } : { title: "", type: "other", cost: "", note: "" });
                setErrorMsg(""); setIsModalOpen(true);
            };

            const deleteAccommodation = () => {
                if(confirm("Á¢∫ÂÆöË¶ÅÁßªÈô§" + (applyToRemaining ? "‰ªäÂ§©ÂèäÂæåÁ∫åÂ§©Êï∏ÁöÑ" : "‰ªäÂ§©ÁöÑ") + "‰ΩèÂÆøÂóéÔºü")) {
                    setTrip(prev => {
                        const newAcc = { ...prev.accommodations };
                        delete newAcc[currentDay];
                        if (applyToRemaining) {
                            for (let i = currentDay + 1; i <= prev.days; i++) delete newAcc[i];
                        }
                        return { ...prev, accommodations: newAcc };
                    });
                    setIsModalOpen(false);
                }
            };

            const saveItem = () => {
                if (!formData.title) { setErrorMsg("Ë´ãËº∏ÂÖ•ÂêçÁ®±"); return; }
                const cost = Number(formData.cost) || 0;
                if (modalType === 'activity') {
                    const validLinks = formData.links.filter(l => l.url.trim() !== "");
                    const newAct = { id: editingId || Date.now(), day: currentDay, ...formData, links: validLinks, cost };
                    delete newAct.driveLink; 
                    setTrip(prev => ({ ...prev, activities: editingId ? prev.activities.map(a => a.id === editingId ? newAct : a) : [...prev.activities, newAct] }));
                } else if (modalType === 'accommodation') {
                    setTrip(prev => {
                        const newAcc = { ...prev.accommodations };
                        newAcc[currentDay] = { title: formData.title, location: formData.location, cost };
                        if (applyToRemaining) for (let i = currentDay + 1; i <= prev.days; i++) newAcc[i] = newAcc[currentDay];
                        return { ...prev, accommodations: newAcc };
                    });
                } else if (modalType === 'expense') {
                    const newExp = { id: editingId || Date.now(), day: currentDay, title: formData.title, type: formData.type, cost, note: formData.note };
                    setTrip(prev => ({ ...prev, expenses: editingId ? prev.expenses.map(e => e.id === editingId ? newExp : e) : [...(prev.expenses || []), newExp] }));
                }
                setIsModalOpen(false);
            };

            // Links handlers
            const addLink = () => setFormData(p => ({ ...p, links: [...p.links, { url: "", title: "" }] }));
            const removeLink = (idx) => setFormData(p => ({ ...p, links: p.links.filter((_, i) => i !== idx) }));
            const updateLink = (idx, field, val) => setFormData(p => ({ ...p, links: p.links.map((l, i) => i === idx ? { ...l, [field]: val } : l) }));

            const delItem = (id) => { setEditingId(id); setModalType('delete'); setIsModalOpen(true); };
            const delExp = (id) => { setEditingId(id); setModalType('deleteExp'); setIsModalOpen(true); };
            const delDay = () => { setModalType('deleteDay'); setIsModalOpen(true); };
            const confirmSort = () => { setModalType('sort'); setIsModalOpen(true); };
            
            const doDel = () => { setTrip(prev => ({ ...prev, activities: prev.activities.filter(a => a.id !== editingId) })); setIsModalOpen(false); };
            const doDelExp = () => { setTrip(prev => ({ ...prev, expenses: prev.expenses.filter(e => e.id !== editingId) })); setIsModalOpen(false); };
            const doDelDay = () => {
                setTrip(prev => {
                    const acts = prev.activities.filter(a => a.day !== currentDay).map(a => a.day > currentDay ? { ...a, day: a.day - 1 } : a);
                    const exps = (prev.expenses || []).filter(e => e.day !== currentDay).map(e => e.day > currentDay ? { ...e, day: e.day - 1 } : e);
                    const accs = {}; const titles = {};
                    if(prev.accommodations) Object.keys(prev.accommodations).forEach(k => { const d = parseInt(k); if(d < currentDay) accs[d] = prev.accommodations[k]; else if(d > currentDay) accs[d-1] = prev.accommodations[k]; });
                    if(prev.dayTitles) Object.keys(prev.dayTitles).forEach(k => { const d = parseInt(k); if(d < currentDay) titles[d] = prev.dayTitles[k]; else if(d > currentDay) titles[d-1] = prev.dayTitles[k]; });
                    return { ...prev, days: prev.days - 1, activities: acts, accommodations: accs, expenses: exps, dayTitles: titles };
                });
                if (currentDay > 1) setCurrentDay(currentDay - 1);
                setIsModalOpen(false);
            };

            const openMemoModal = () => { setMemoText(trip.memo || ""); setModalType('memo'); setIsModalOpen(true); };
            const saveMemo = () => { setTrip(prev => ({ ...prev, memo: memoText })); setIsModalOpen(false); };

            const handleBackup = () => { setModalType('backup'); setIsModalOpen(true); };
            const handleExport = () => { setExportText(JSON.stringify(trip)); setModalType('export'); setIsModalOpen(true); }; 
            
            const downloadBackup = () => {
                const dataStr = JSON.stringify(trip, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `trip_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const triggerFileUpload = () => { fileInputRef.current.click(); };
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const p = JSON.parse(e.target.result);
                        if (p.activities) { 
                            if (!p.expenses) p.expenses = [];
                            if (!p.memo) p.memo = "";
                            setTrip(p); 
                            setIsModalOpen(false); 
                            alert("ËÆÄÂèñÊàêÂäüÔºÅ"); 
                        } else { setErrorMsg("Ê™îÊ°àÊ†ºÂºèÈåØË™§"); }
                    } catch (err) { setErrorMsg("ÁÑ°ÊïàÁöÑÊ™îÊ°à"); }
                };
                reader.readAsText(file);
            };

            const openAuthModal = () => { setModalType('auth'); setIsModalOpen(true); };

            // Manual Copy/Paste Handlers
            const openTransferModal = () => { setExportText(JSON.stringify(trip)); setImportText(""); setErrorMsg(""); setModalType('backup'); setIsModalOpen(true); };
            const doCopyCode = () => { navigator.clipboard.writeText(exportText); alert("‰ª£Á¢ºÂ∑≤Ë§áË£ΩÔºÅË´ãË≤ºÂà∞ Line Êàñ Email ÂÇ≥ÈÄÅ„ÄÇ"); };
            const doPasteCode = () => { try { const p = JSON.parse(importText); if(p.activities) { if(!p.expenses) p.expenses=[]; setTrip(p); setIsModalOpen(false); alert("Ë≥áÊñôÂ∑≤ËΩâÁßªÊàêÂäüÔºÅ"); } else setErrorMsg("‰ª£Á¢ºÊ†ºÂºèÈåØË™§"); } catch(e){ setErrorMsg("ÁÑ°ÊïàÁöÑ‰ª£Á¢º"); } };


            // Stats
            const statsData = useMemo(() => {
                const breakdown = { sight: 0, food: 0, transport: 0, stay: 0, other: 0 };
                trip.activities.forEach(a => { if (breakdown[a.type] !== undefined) breakdown[a.type] += (a.cost || 0); });
                (trip.expenses || []).forEach(e => { if (breakdown[e.type] !== undefined) breakdown[e.type] += (e.cost || 0); });
                if(trip.accommodations) Object.values(trip.accommodations).forEach(acc => { breakdown.stay += (acc.cost || 0); });
                return Object.entries(breakdown).map(([key, val]) => ({ label: TYPE_CONFIG[key].label, value: val, color: TYPE_CONFIG[key].chartColor })).filter(d => d.value > 0);
            }, [trip]);

            const dayActs = trip.activities.filter(a => a.day === currentDay);
            const dayExps = (trip.expenses || []).filter(e => e.day === currentDay);
            const dayCost = dayActs.reduce((s, i) => s + i.cost, 0) + dayExps.reduce((s, i) => s + i.cost, 0) + (trip.accommodations?.[currentDay]?.cost || 0);
            const currAcc = trip.accommodations?.[currentDay];
            const currentTitle = trip.dayTitles?.[currentDay] || `Day ${currentDay}`;

            return (
                <div className="min-h-screen supports-[min-h-[100dvh]]:min-h-[100dvh] w-full bg-slate-50 text-slate-800 pb-24 md:pb-0 overscroll-y-none touch-pan-y relative">
                    {showSavedToast && <div className="fixed bottom-20 left-4 bg-teal-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg z-50 animate-toast flex items-center gap-1"><LucideIcon name="Check" size={12}/> Â∑≤ÂÑ≤Â≠ò {syncStatus==='syncing' && '(ÂêåÊ≠•‰∏≠...)'}</div>}
                    
                    <header className="bg-teal-600 text-white p-4 shadow-lg sticky top-0 z-30 safe-top flex justify-between items-center">
                        <div>
                            <div className="flex items-center gap-2 mb-1"><LucideIcon name="Plane" className="text-teal-200"/><input value={trip.tripName} onChange={e => setTrip(p => ({...p, tripName: e.target.value}))} className="bg-transparent font-bold text-xl outline-none border-b border-teal-300 w-full md:w-auto"/></div>
                            <div className="text-teal-100 text-sm flex items-center gap-2"><input type="date" value={trip.startDate} onChange={e => setTrip(p => ({...p, startDate: e.target.value}))} className="bg-transparent outline-none"/><span>‚Ä¢ {trip.days} Â§©</span></div>
                        </div>
                        <div className="flex gap-3 items-center">
                            <button onClick={openAuthModal} className={`p-2 rounded-full transition-colors ${user ? 'bg-teal-500 text-white' : 'bg-white/20 hover:bg-white/30'}`} title="Èõ≤Á´ØÂêåÊ≠•">
                                <LucideIcon name="Cloud" />
                            </button>
                            <button onClick={openMemoModal} className="p-2 rounded-full bg-white/20 hover:bg-white/30" title="Á≠ÜË®ò"><LucideIcon name="StickyNote"/></button>
                            <button onClick={()=> {setModalType('stats'); setIsModalOpen(true)}} className="p-2 rounded-full bg-white/20 hover:bg-white/30"><LucideIcon name="PieChart"/></button>
                            <button onClick={()=> {setModalType('settings'); setIsModalOpen(true)}} className="p-2 rounded-full bg-white/20 hover:bg-white/30"><LucideIcon name="Settings"/></button>
                            <button onClick={() => setIsSummaryView(!isSummaryView)} className={`p-2 rounded-full flex gap-1 items-center ${isSummaryView?'bg-white/30 ring-2':'bg-white/20'}`}>{isSummaryView ? <LucideIcon name="ArrowLeft"/> : <LucideIcon name="List"/>}</button>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-4 md:flex gap-6 mt-4">
                        {isSummaryView ? (
                            <div className="w-full space-y-6">
                                <h2 className="text-xl font-bold px-2">Ë°åÁ®ãÁ∏ΩË¶Ω (ÊãñÊõ≥ÊéíÂ∫è)</h2>
                                {Array.from({ length: trip.days }).map((_, i) => {
                                    const d = i + 1; const acts = trip.activities.filter(a => a.day === d); const acc = trip.accommodations?.[d];
                                    return (
                                        <div key={d} draggable onDragStart={e => handleDragStart(e, i)} onDragEnter={e => handleDragEnter(e, i)} onDragEnd={e => {e.target.classList.remove('dragging'); handleDaySort();}} onDragOver={e=>e.preventDefault()} onClick={() => {setCurrentDay(d); setIsSummaryView(false);}} className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden cursor-pointer active:cursor-grabbing">
                                            <div className="bg-slate-50 p-3 border-b flex justify-between"><div className="flex gap-2"><LucideIcon name="GripVertical" className="text-slate-400"/><h3 className="font-bold">{trip.dayTitles?.[d] || `Day ${d}`}</h3></div><span className="text-xs text-teal-600 bg-teal-50 px-2 py-1 rounded-full">Ë©≥Á¥∞ &gt;</span></div>
                                            <div className="p-4">
                                                {acc?.title && <div className="mb-2 flex gap-2 text-sm text-indigo-600 bg-indigo-50 p-2 rounded"><LucideIcon name="Home" size={14}/><span className="truncate">{acc.title}</span></div>}
                                                {acts.length ? acts.map(a => <div key={a.id} className="flex gap-2 text-sm items-center py-0.5"><span className="font-mono text-slate-400 text-xs w-10 shrink-0">{a.time}</span><div className={`w-2 h-2 rounded-full ${TYPE_CONFIG[a.type].color.split(' ')[0]}`}/> <span className="truncate">{a.title}</span></div>) : <p className="text-slate-400 text-sm italic">ÁÑ°Ë°åÁ®ã</p>}
                                            </div>
                                        </div>
                                    );
                                })}
                                <div className="mt-4"><button onClick={openTransferModal} className="w-full flex justify-center gap-2 bg-slate-200 text-slate-700 font-bold py-3 rounded-xl"><LucideIcon name="Download"/> üì≤ Ë∑®Ë£ùÁΩÆËΩâÁßª / ÂÇô‰ªΩ</button></div>
                            </div>
                        ) : (
                            <>
                                <aside className="md:w-48 mb-6 md:mb-0 flex-shrink-0 flex md:flex-col overflow-x-auto gap-2 pb-2 scrollbar-hide">
                                    {Array.from({ length: trip.days }).map((_, i) => (
                                        <button key={i+1} onClick={() => setCurrentDay(i+1)} className={`flex-shrink-0 px-4 py-3 rounded-xl text-left border ${currentDay===i+1 ? 'bg-white border-teal-500 text-teal-700 shadow-md' : 'bg-white/50 border-transparent text-slate-500'}`}>
                                            <span className="text-xs font-bold block opacity-70">Day {i+1}</span><span className="font-bold">Á¨¨ {i+1} Â§©</span>
                                        </button>
                                    ))}
                                    <button onClick={() => setTrip(p => ({...p, days: p.days + 1}))} className="flex-shrink-0 px-4 py-3 rounded-xl border-2 border-dashed text-slate-400 flex items-center justify-center min-w-[100px]"><LucideIcon name="Plus"/></button>
                                </aside>

                                <div className="flex-1">
                                    <div className="flex justify-between items-center mb-4">
                                        <div className="flex items-center gap-2 flex-1">
                                            <input className="text-xl font-bold text-slate-800 bg-transparent outline-none w-full" value={currentTitle} onChange={(e) => setTrip(p => ({...p, dayTitles: {...p.dayTitles, [currentDay]: e.target.value}}))} placeholder={`Day ${currentDay}`} />
                                            {trip.days > 1 && <button onClick={delDay} className="p-1 text-slate-400 hover:text-red-500"><LucideIcon name="Trash2"/></button>}
                                        </div>
                                        <div className="flex items-center gap-2 shrink-0">
                                            <button onClick={runAIAnalysis} className="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full flex gap-1 font-bold"><LucideIcon name="Sparkles" size={14}/> AI ÂàÜÊûê</button>
                                            <button onClick={confirmSort} className="text-xs bg-slate-200 px-2 py-1 rounded flex gap-1"><LucideIcon name="ArrowUpDown" size={12}/>ÊéíÂ∫è</button>
                                        </div>
                                    </div>

                                    <div className="mb-6">
                                        {currAcc?.title ? (
                                            <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-4 flex justify-between items-center shadow-sm">
                                                <div className="flex gap-4 overflow-hidden items-center"><div className="bg-indigo-100 p-2 rounded-full text-indigo-600"><LucideIcon name="Home"/></div><div className="min-w-0"><div className="text-xs font-bold text-indigo-500 uppercase">‰ªäÊôö‰ΩèÂÆø</div><h3 className="font-bold truncate">{currAcc.title}</h3>{currAcc.cost > 0 && <div className="text-xs text-indigo-400 font-bold mt-1">${currAcc.cost.toLocaleString()}</div>}</div></div>
                                                <div className="flex gap-2 shrink-0"><a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currAcc.location||currAcc.title)}`} target="_blank" className="bg-indigo-600 text-white p-2 rounded-lg"><LucideIcon name="Navigation"/></a><button onClick={openAccModal} className="p-2 text-indigo-300"><LucideIcon name="Edit2"/></button></div>
                                            </div>
                                        ) : <button onClick={openAccModal} className="w-full border-2 border-dashed border-indigo-200 bg-indigo-50/50 rounded-xl p-4 text-indigo-400 font-bold flex justify-center gap-2"><LucideIcon name="BedDouble"/> Ë®≠ÂÆö‰ΩèÂÆø</button>}
                                    </div>

                                    <div className="space-y-4 relative">
                                        <div className="absolute left-6 top-4 bottom-4 w-0.5 bg-slate-200 z-0"></div>
                                        {dayActs.map((item, idx) => {
                                            const tc = TYPE_CONFIG[item.type];
                                            const displayLinks = item.links && item.links.length > 0 ? item.links : (item.driveLink ? [{url: item.driveLink, title: 'Êñá‰ª∂'}] : []);
                                            return (
                                                <div key={item.id} draggable onDragStart={e => handleDragStart(e, idx)} onDragEnter={e => handleDragEnter(e, idx)} onDragEnd={e => {e.target.classList.remove('dragging'); handleDragEnd(e);}} onDragOver={e => {e.preventDefault(); handleActivitySort();}} className="relative z-10 flex gap-4 group cursor-move">
                                                    <div className="flex flex-col items-center pt-1"><div className={`bg-white p-1 rounded-full border shadow-sm ${tc.color.replace('bg-', 'text-')}`}><LucideIcon name={tc.icon}/></div><div className="mt-1 text-slate-300 md:hidden"><LucideIcon name="GripVertical" size={14}/></div></div>
                                                    <div className="flex-1 bg-white rounded-xl p-4 shadow-sm border relative overflow-hidden">
                                                        <div className={`absolute top-0 left-0 w-1 h-full ${tc.color.split(' ')[0].replace('bg-', 'bg-')}`}/>
                                                        <div className="flex justify-between mb-1"><div className="flex items-center gap-2"><span className="font-mono font-bold text-teal-700 text-lg">{item.time}</span><span className={`text-xs px-2 py-0.5 rounded-full ${tc.color}`}>{tc.label}</span></div><div className="flex gap-2"><button onClick={(e)=>{e.stopPropagation(); openModal(item)}} className="text-slate-400"><LucideIcon name="Edit2" size={16}/></button><button onClick={(e)=>{e.stopPropagation(); delItem(item.id)}} className="text-slate-400 hover:text-red-500"><LucideIcon name="Trash2" size={16}/></button></div></div>
                                                        <div className="mb-1"><h3 className="font-bold text-lg leading-tight">{item.title}</h3>
                                                            <div className="flex flex-wrap gap-2 mt-1">
                                                                <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location||item.title)}`} target="_blank" className="text-xs px-2 border rounded-full flex gap-1 items-center bg-teal-50 text-teal-600 border-teal-200" onClick={e=>e.stopPropagation()}><LucideIcon name="MapPin" size={14}/> Â∞éËà™</a>
                                                                {displayLinks.map((l, i) => { const ld = getLinkData(l.url); return <a key={i} href={l.url} target="_blank" className={`text-xs px-2 border rounded-full flex gap-1 items-center ${ld.color}`} onClick={e=>e.stopPropagation()}><LucideIcon name={ld.icon} size={14}/> {l.title || ld.label}</a> })}
                                                            </div>
                                                        </div>
                                                        {item.note && <p className="text-slate-500 text-sm">{item.note}</p>}
                                                        {item.cost > 0 && <div className="flex items-center gap-1 text-slate-600 text-sm font-medium mt-1 pt-1 border-t"><LucideIcon name="DollarSign" size={14}/> {item.cost.toLocaleString()}</div>}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        <button onClick={() => openModal()} className="relative z-10 ml-14 w-full md:w-auto px-6 py-3 bg-white border-2 border-dashed text-slate-400 rounded-xl hover:border-teal-400 hover:text-teal-500 flex justify-center gap-2"><LucideIcon name="Plus"/> Êñ∞Â¢ûË°åÁ®ã</button>
                                    </div>

                                    {/* Daily Expenses Section */}
                                    <div className="mt-8 pt-4 border-t border-slate-200">
                                        <h3 className="font-bold text-slate-600 mb-3 px-1 flex items-center gap-2"><LucideIcon name="Receipt" size={18}/> ‰ªäÊó•È°çÂ§ñËä±Ë≤ª</h3>
                                        <div className="space-y-2 mb-3">
                                            {dayExps.map(exp => (
                                                <div key={exp.id} className="bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center shadow-sm">
                                                    <div>
                                                        <div className="font-bold text-slate-700">{exp.title}</div>
                                                        <div className="text-xs text-slate-400 flex gap-2"><span>{TYPE_CONFIG[exp.type].label}</span>{exp.note && <span>‚Ä¢ {exp.note}</span>}</div>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <span className="font-mono font-bold text-slate-600">${exp.cost.toLocaleString()}</span>
                                                        <div className="flex gap-1">
                                                            <button onClick={()=>openExpenseModal(exp)} className="text-slate-300 hover:text-slate-500"><LucideIcon name="Edit2" size={14}/></button>
                                                            <button onClick={()=>delExp(exp.id)} className="text-slate-300 hover:text-red-500"><LucideIcon name="Trash2" size={14}/></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            {dayExps.length === 0 && <p className="text-slate-400 text-sm italic px-1">Â∞öÁÑ°Á¥ÄÈåÑ</p>}
                                        </div>
                                        <button onClick={()=>openExpenseModal()} className="w-full py-2 bg-orange-50 text-orange-600 font-bold rounded-lg border border-orange-200 hover:bg-orange-100 flex justify-center gap-1 text-sm"><LucideIcon name="Plus" size={16}/> Ë®ò‰∏ÄÁ≠Ü</button>
                                    </div>
                                </div>
                            </>
                        )}
                    </main>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-modal">
                            <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
                                <div className="bg-slate-50 p-4 border-b flex justify-between shrink-0"><h3 className="font-bold text-lg">{modalType==='delete'?'Á¢∫Ë™çÂà™Èô§':modalType==='deleteExp'?'Âà™Èô§Ëä±Ë≤ª':modalType==='deleteDay'?'Âà™Èô§Â§©Êï∏':modalType==='backup'?'üì≤ Ë∑®Ë£ùÁΩÆËΩâÁßª':modalType==='sort'?'ÊéíÂ∫è':modalType==='settings'?'Ë®≠ÂÆö':modalType==='ai_result'?'AI Âª∫Ë≠∞':modalType==='stats'?'Ëä±Ë≤ªÁµ±Ë®à':modalType==='expense'?'Ë®òÂ∏≥':modalType==='memo'?'ÈáçË¶ÅÁ≠ÜË®ò':modalType==='auth'?'Èõ≤Á´ØÁôªÂÖ•':editingId?'Á∑®ËºØ':'Êñ∞Â¢û'}</h3><button onClick={()=>setIsModalOpen(false)} className="text-slate-400">‚úï</button></div>
                                <div className="p-6 space-y-4 overflow-y-auto">
                                    {(modalType==='delete'||modalType==='deleteDay'||modalType==='deleteExp'||modalType==='sort') ? (
                                        <div className="text-center">
                                            <div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><LucideIcon name="AlertTriangle" size={32}/></div>
                                            <p className="mb-6 text-slate-600">{modalType==='sort'?'Ëá™Âãï‰æùÊôÇÈñìÊéíÂ∫èË°åÁ®ãÔºü':'Á¢∫ÂÆöË¶ÅÂà™Èô§ÂóéÔºüÁÑ°Ê≥ïÂæ©Âéü„ÄÇ'}</p>
                                            <div className="flex gap-3"><button onClick={()=>setIsModalOpen(false)} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold">ÂèñÊ∂à</button><button onClick={modalType==='delete'?doDel:modalType==='deleteExp'?doDelExp:modalType==='sort'?autoSortByTime:doDelDay} className="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold">Á¢∫Ë™ç</button></div>
                                        </div>
                                    ) : modalType === 'backup' ? (
                                        <div className="space-y-6">
                                            <div className="space-y-2">
                                                <div className="flex items-center justify-between"><h4 className="font-bold text-teal-800 flex items-center gap-2"><LucideIcon name="Smartphone"/> 1. ÂæûÈÄôË£°ÂåØÂá∫</h4><span className="text-xs bg-teal-100 text-teal-800 px-2 py-0.5 rounded-full">ÂÇ≥ÈÄÅÁ´Ø</span></div>
                                                <p className="text-xs text-slate-500">Â∞á‰ª£Á¢ºË§áË£ΩÂæåÔºåÈÄèÈÅé Line / Email ÂÇ≥ÈÄÅÁµ¶Âè¶‰∏ÄÂè∞Ë£ùÁΩÆ„ÄÇ</p>
                                                <textarea className="w-full h-20 bg-slate-100 p-2 rounded text-xs break-all" readOnly value={exportText} onClick={e=>e.target.select()}></textarea>
                                                <button onClick={doCopyCode} className="w-full bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg flex justify-center gap-2"><LucideIcon name="Copy"/> Ë§áË£ΩË°åÁ®ã‰ª£Á¢º</button>
                                            </div>
                                            <div className="border-t border-slate-200"></div>
                                            <div className="space-y-2">
                                                <div className="flex items-center justify-between"><h4 className="font-bold text-slate-700 flex items-center gap-2"><LucideIcon name="Monitor"/> 2. Ë≤º‰∏ä‰∏¶ÈÇÑÂéü</h4><span className="text-xs bg-slate-200 text-slate-700 px-2 py-0.5 rounded-full">Êé•Êî∂Á´Ø</span></div>
                                                <p className="text-xs text-slate-500">Â∞áÊî∂Âà∞ÁöÑ‰ª£Á¢ºË≤ºÂú®‰∏ãÊñπÔºåÂç≥ÂèØÈÇÑÂéüË°åÁ®ã„ÄÇ</p>
                                                <textarea className="w-full h-20 bg-white border p-2 rounded text-xs mb-2" value={importText} onChange={e=>{setImportText(e.target.value);setErrorMsg("")}} placeholder="Âú®Ê≠§Ë≤º‰∏ä‰ª£Á¢º..."></textarea>
                                                {errorMsg && <p className="text-red-500 text-xs mb-2">{errorMsg}</p>}
                                                <button onClick={doPasteCode} className="w-full bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg flex justify-center gap-2"><LucideIcon name="Check"/> Á¢∫ÂÆöÈÇÑÂéü</button>
                                            </div>
                                            <div className="border-t border-slate-200"></div>
                                            <div className="text-center">
                                                <div className="mb-2 text-sm font-bold text-slate-700">‰∏ãËºâ/ËÆÄÂèñÂÇô‰ªΩÊ™î</div>
                                                <div className="flex gap-2">
                                                    <button onClick={downloadBackup} className="flex-1 bg-slate-100 py-2 rounded-lg text-xs font-bold">‰∏ãËºâ .json</button>
                                                    <button onClick={triggerFileUpload} className="flex-1 bg-slate-100 py-2 rounded-lg text-xs font-bold">ËÆÄÂèñÊ™îÊ°à</button>
                                                    <input type="file" accept=".json" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                                                </div>
                                            </div>
                                        </div>
                                    ) : modalType === 'memo' ? (
                                        <div>
                                            <p className="text-sm text-slate-500 mb-2">Âú®Ê≠§Ëº∏ÂÖ•Ëà™Áè≠Ë≥áË®ä„ÄÅË®Ç‰Ωç‰ª£ËôüÁ≠âÈáçË¶ÅÁ≠ÜË®òÔºö</p>
                                            <textarea className="w-full h-64 bg-slate-50 border p-3 rounded-xl text-sm focus:outline-none resize-none" value={memoText} onChange={e=>setMemoText(e.target.value)} placeholder="‰æãÂ¶ÇÔºöËà™Áè≠ BR132, Ë®ÇÊàø‰ª£Ëôü #12345..."></textarea>
                                            <button onClick={saveMemo} className="w-full bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg mt-2">ÂÑ≤Â≠òÁ≠ÜË®ò</button>
                                        </div>
                                    ) : modalType === 'auth' ? (
                                        <div className="space-y-4">
                                            {user ? (
                                                <div className="text-center">
                                                    <p className="text-lg font-bold text-slate-800 mb-2">Â∑≤ÁôªÂÖ•</p>
                                                    <p className="text-sm text-slate-500 mb-4">{user.email}</p>
                                                    <button onClick={handleLogout} className="w-full bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg">ÁôªÂá∫</button>
                                                </div>
                                            ) : (
                                                <>
                                                    <p className="text-sm text-slate-500 text-center mb-4">{isLoginMode ? 'ÁôªÂÖ•ÂæåÂèØË∑®Ë£ùÁΩÆÂêåÊ≠•Ë°åÁ®ã' : 'Ë®ªÂÜäÊñ∞Â∏≥Ëôü‰ª•‰øùÂ≠òË°åÁ®ã'}</p>
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-500">Email</label>
                                                        <input type="email" value={authEmail} onChange={e=>setAuthEmail(e.target.value)} className="w-full border p-3 rounded-xl mb-2"/>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-500">ÂØÜÁ¢º</label>
                                                        <input type="password" value={authPass} onChange={e=>setAuthPass(e.target.value)} className="w-full border p-3 rounded-xl mb-4"/>
                                                    </div>
                                                    <button onClick={handleAuth} disabled={authLoading} className="w-full bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg mb-2">
                                                        {authLoading ? 'ËôïÁêÜ‰∏≠...' : (isLoginMode ? 'ÁôªÂÖ•' : 'Ë®ªÂÜä')}
                                                    </button>
                                                    <div className="text-center text-xs text-slate-400">
                                                        <span onClick={()=>setIsLoginMode(!isLoginMode)} className="underline cursor-pointer hover:text-teal-600">
                                                            {isLoginMode ? 'ÈÇÑÊ≤íÊúâÂ∏≥ËôüÔºüË®ªÂÜä' : 'Â∑≤ÊúâÂ∏≥ËôüÔºüÁôªÂÖ•'}
                                                        </span>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    ) : modalType === 'settings' ? (
                                        <div><p className="text-sm mb-2">Gemini API Key:</p><input type="password" value={apiKey} onChange={e=>setApiKey(e.target.value)} className="w-full border p-3 rounded-xl mb-4"/><button onClick={()=>setIsModalOpen(false)} className="w-full bg-teal-600 text-white font-bold py-3 rounded-xl">ÂÑ≤Â≠ò</button></div>
                                    ) : modalType === 'ai_result' ? (
                                        <div className="prose prose-sm text-slate-700">{isAiLoading?<div className="text-center py-8 animate-pulse text-teal-600">AI ÊÄùËÄÉ‰∏≠...</div>:<div dangerouslySetInnerHTML={{ __html: marked.parse(aiResult) }} />}</div>
                                    ) : modalType === 'stats' ? (
                                        <PieChart data={statsData} />
                                    ) : (
                                        <>
                                            {modalType==='activity' ? (
                                                <>
                                                    <div className="grid grid-cols-2 gap-4"><InputField label="ÊôÇÈñì" type="time" name="time" value={formData.time} onChange={e=>setFormData({...formData, time: e.target.value})}/><div><label className="block text-xs font-bold text-slate-500 mb-1">È°ûÂûã</label><select value={formData.type} onChange={e=>setFormData({...formData, type: e.target.value})} className="w-full bg-slate-50 border rounded-lg px-3 py-2 outline-none text-base">{Object.entries(TYPE_CONFIG).map(([k,c])=><option key={k} value={k}>{c.label}</option>)}</select></div></div>
                                                    <InputField label="ÂêçÁ®±" name="title" value={formData.title} onChange={handleInputChange}/>
                                                    <InputField label="Âú∞Èªû" name="location" value={formData.location} onChange={handleInputChange}/>
                                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">ÈÄ£Áµê</label>{formData.links.map((l, i) => (<div key={i} className="flex gap-2 mb-2"><input className="w-1/3 bg-slate-50 border rounded px-2 py-2 text-sm" placeholder="Ê®ôÈ°å" value={l.title} onChange={e=>updateLink(i,'title',e.target.value)}/><input className="flex-1 bg-slate-50 border rounded px-2 py-2 text-sm" placeholder="Á∂≤ÂùÄ" value={l.url} onChange={e=>updateLink(i,'url',e.target.value)}/><button onClick={()=>removeLink(i)} className="text-slate-400"><LucideIcon name="Trash2" size={18}/></button></div>))}<button onClick={addLink} className="text-xs text-teal-600 font-bold flex items-center gap-1"><LucideIcon name="Plus" size={14}/> Êñ∞Â¢ûÈÄ£Áµê</button></div>
                                                    <CostInput label="Ëä±Ë≤ª" value={formData.cost} onChange={handleInputChange} />
                                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">ÂÇôË®ª</label><textarea name="note" rows="3" value={formData.note} onChange={handleInputChange} className="w-full bg-slate-50 border rounded-lg px-3 py-2 outline-none resize-none text-base"></textarea></div>
                                                </>
                                            ) : modalType === 'expense' ? (
                                                <>
                                                    <InputField label="È†ÖÁõÆÂêçÁ®±" name="title" value={formData.title} onChange={handleInputChange} placeholder="‰æãÂ¶ÇÔºöÁ¥ÄÂøµÂìÅ"/>
                                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">ÂàÜÈ°û</label><select value={formData.type} onChange={e=>setFormData({...formData, type: e.target.value})} className="w-full bg-slate-50 border rounded-lg px-3 py-2 outline-none text-base">{Object.entries(TYPE_CONFIG).map(([k,c])=><option key={k} value={k}>{c.label}</option>)}</select></div>
                                                    <CostInput label="ÈáëÈ°ç" value={formData.cost} onChange={handleInputChange} />
                                                    <InputField label="ÂÇôË®ª (ÈÅ∏Â°´)" name="note" value={formData.note} onChange={handleInputChange}/>
                                                </>
                                            ) : (
                                                <>
                                                    <InputField label="‰ΩèÂÆøÂêçÁ®±" name="title" value={formData.title} onChange={handleInputChange}/>
                                                    <InputField label="Âú∞ÂùÄ" name="location" value={formData.location} onChange={handleInputChange}/>
                                                    <CostInput label="‰ΩèÂÆøËä±Ë≤ª" value={formData.cost} onChange={handleInputChange} />
                                                    {currentDay < trip.days && <div className="flex items-center gap-2 py-1"><input type="checkbox" checked={applyToRemaining} onChange={e=>setApplyToRemaining(e.target.checked)} className="w-4 h-4"/><label className="text-sm">Â•óÁî®Âà∞ÂæåÁ∫åÂ§©Êï∏</label></div>}
                                                    <div className="flex gap-2 mt-4">
                                                        <button onClick={deleteAccommodation} className="flex-1 bg-red-100 text-red-500 font-bold py-3 rounded-xl shadow-sm hover:bg-red-200">ÁßªÈô§‰ΩèÂÆø</button>
                                                        <button onClick={saveItem} className="flex-[2] bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700">ÂÑ≤Â≠ò</button>
                                                    </div>
                                                </>
                                            )}
                                            {errorMsg && <p className="text-red-500 text-xs mb-2 text-center">{errorMsg}</p>}
                                            {modalType !== 'accommodation' && <button onClick={saveItem} className={`w-full text-white font-bold py-3 rounded-xl shadow-lg ${modalType==='expense'?'bg-orange-500':'bg-teal-600'}`}>ÂÑ≤Â≠ò</button>}
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
